matrix:
  include:
    - name: "OS X"
      sudo: false
      os: osx
      osx_image: xcode10.1
      language: swift
      script:
        - swift test

    - name: "Linux"
      sudo: false
      os: linux
      dist: xenial
      language: c
      services:
        - mysql
      before_script:
        - wget https://swift.org/builds/swift-4.2.2-release/ubuntu1604/swift-4.2.2-RELEASE/swift-4.2.2-RELEASE-ubuntu16.04.tar.gz
        - tar xzf swift-4.2.2-RELEASE-ubuntu16.04.tar.gz
        - export PATH=$(pwd)/swift-4.2.2-RELEASE-ubuntu16.04/usr/bin:"${PATH}"
      script:
        - swift test

# This job is unfortunately flaky because swift test --generate-linuxmain doesn't generate values in sorted
# order. See https://bugs.swift.org/browse/SR-9872 for bug tracking resolution of this.
    - name: "Check Linux Test Cases"
      os: osx
      osx_image: xcode10.1
      language: swift
      before_script:
        - wget https://swift.org/builds/development/xcode/swift-DEVELOPMENT-SNAPSHOT-2019-02-03-a/swift-DEVELOPMENT-SNAPSHOT-2019-02-03-a-osx.pkg
        - sudo installer -pkg swift-DEVELOPMENT-SNAPSHOT-2019-02-03-a-osx.pkg -target /
        - export PATH=/Library/Developer/Toolchains/swift-latest.xctoolchain/usr/bin:"${PATH}"
        - swift --version
      script:
        - swift test --generate-linuxmain
        - git diff # Appears to be necessary for the next check to work as expected.
        - |
          if ! git diff-index --quiet HEAD --; then
            echo "Linux tests are out of date. Please run the following command:"
            echo
            echo "    swift test --generate-linuxmain"
            exit 1
          fi
